[[extend 'layout.html']]

<div class="card">
    <div class="card-header">
        <h2 class="card-title">Permission Matrix</h2>
    </div>
    
    [[if tokens and domains:]]
    <div style="overflow-x: auto;">
        <table>
            <thead>
                <tr>
                    <th>Token / Domain</th>
                    [[for domain in domains:]]
                    <th class="checkbox-cell">
                        [[=domain.name]]
                        [[if domain.name == '*':]]
                            <br><small>(All)</small>
                        [[pass]]
                    </th>
                    [[pass]]
                </tr>
            </thead>
            <tbody>
                [[for token in tokens:]]
                <tr>
                    <td>
                        <strong>[[=token.name]]</strong>
                        [[if not token.active:]]
                            <span class="badge badge-danger">Inactive</span>
                        [[pass]]
                    </td>
                    [[for domain in domains:]]
                    <td class="checkbox-cell">
                        <input type="checkbox" 
                               class="permission-checkbox"
                               data-token-id="[[=token.id]]"
                               data-domain-id="[[=domain.id]]"
                               [[='checked' if matrix[token.id][domain.id] else '']]
                               [[='disabled' if not token.active else '']
                               onchange="togglePermission(this)">
                    </td>
                    [[pass]]
                </tr>
                [[pass]]
            </tbody>
        </table>
    </div>
    
    <div style="margin-top: 1rem;">
        <p style="color: #7f8c8d;">
            Check/uncheck boxes to grant or revoke domain access for tokens. 
            Changes are saved automatically.
        </p>
    </div>
    [[else:]]
    <p>No tokens or domains configured yet. Please create at least one token and one domain first.</p>
    [[pass]]
</div>

<script>
function togglePermission(checkbox) {
    const tokenId = checkbox.dataset.tokenId;
    const domainId = checkbox.dataset.domainId;
    const isChecked = checkbox.checked;
    
    // Disable checkbox during request
    checkbox.disabled = true;
    
    fetch('[[=URL("permissions/toggle")]]', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            token_id: tokenId,
            domain_id: domainId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update checkbox state based on server response
            checkbox.checked = data.new_state;
            
            // Show visual feedback
            checkbox.style.outline = '2px solid #27ae60';
            setTimeout(() => {
                checkbox.style.outline = '';
            }, 1000);
        } else {
            // Revert checkbox on error
            checkbox.checked = !isChecked;
            alert('Error updating permission: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        // Revert checkbox on error
        checkbox.checked = !isChecked;
        alert('Network error: ' + error);
    })
    .finally(() => {
        // Re-enable checkbox
        checkbox.disabled = false;
    });
}
</script>