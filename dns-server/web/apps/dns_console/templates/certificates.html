[[extend 'layout.html']]

<div class="container mt-4">
    <h1>TLS Certificate Management</h1>
    
    [[if error:]]
    <div class="alert alert-danger">
        <strong>Error:</strong> [[=error]]
    </div>
    [[pass]]
    
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h3>mTLS Status</h3>
                </div>
                <div class="card-body">
                    <p><strong>mTLS:</strong> 
                        [[if mtls_enabled:]]
                            <span class="badge bg-success">Enabled</span>
                        [[else:]]
                            <span class="badge bg-secondary">Disabled</span>
                            <small class="text-muted">(Set ENABLE_MTLS=true to enable)</small>
                        [[pass]]
                    </p>
                    <p class="text-muted">
                        Mutual TLS provides client certificate authentication for enhanced security.
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-4">
        <!-- CA Certificate -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3>Certificate Authority (CA)</h3>
                    [[if ca_exists:]]
                        <span class="badge bg-success">Active</span>
                    [[else:]]
                        <span class="badge bg-warning">Not Found</span>
                    [[pass]]
                </div>
                <div class="card-body">
                    [[if ca_exists and ca_info:]]
                        <p><strong>Subject:</strong><br><small>[[=ca_info.get('subject', 'N/A')]]</small></p>
                        <p><strong>Valid Until:</strong> [[=ca_info.get('not_after', 'N/A')[:10] if ca_info.get('not_after') else 'N/A']]</p>
                        <p><strong>Fingerprint:</strong><br><small class="font-monospace">[[=ca_info.get('fingerprint', 'N/A')[:32] + '...' if ca_info.get('fingerprint') else 'N/A']]</small></p>
                        <a href="[[=URL('certificates/download/ca')]]" class="btn btn-sm btn-primary">
                            <i class="fas fa-download"></i> Download CA Certificate
                        </a>
                    [[else:]]
                        <p class="text-muted">CA certificate not found. Initialize certificates to create one.</p>
                    [[pass]]
                </div>
            </div>
        </div>
        
        <!-- Server Certificate -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3>Server Certificate</h3>
                    [[if server_exists:]]
                        <span class="badge bg-success">Active</span>
                    [[else:]]
                        <span class="badge bg-warning">Not Found</span>
                    [[pass]]
                </div>
                <div class="card-body">
                    [[if server_exists and server_info:]]
                        <p><strong>Subject:</strong><br><small>[[=server_info.get('subject', 'N/A')]]</small></p>
                        <p><strong>Valid Until:</strong> [[=server_info.get('not_after', 'N/A')[:10] if server_info.get('not_after') else 'N/A']]</p>
                        [[if server_info.get('subject_alternative_names'):]]
                            <p><strong>Alt Names:</strong><br><small>[[=', '.join(server_info['subject_alternative_names'][:3])]][[if len(server_info['subject_alternative_names']) > 3:]]...[[pass]]</small></p>
                        [[pass]]
                    [[else:]]
                        <p class="text-muted">Server certificate not found. Initialize certificates to create one.</p>
                    [[pass]]
                </div>
            </div>
        </div>
    </div>
    
    <!-- Certificate Initialization -->
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h3>Initialize Certificates</h3>
                </div>
                <div class="card-body">
                    <form method="POST" action="[[=URL('certificates/init')]]">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="hostname" class="form-label">Server Hostname</label>
                                    <input type="text" class="form-control" id="hostname" name="hostname" 
                                           placeholder="dns.example.com (leave empty for auto-detect)">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="ip_addresses" class="form-label">Additional IP Addresses</label>
                                    <input type="text" class="form-control" id="ip_addresses" name="ip_addresses" 
                                           placeholder="192.168.1.10,10.0.0.5 (comma-separated)">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="force" name="force" value="true">
                            <label class="form-check-label" for="force">
                                Force regeneration (overwrite existing certificates)
                            </label>
                        </div>
                        <button type="submit" class="btn btn-primary">Initialize Certificates</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Client Certificates -->
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3>Client Certificates</h3>
                    <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addClientModal">
                        <i class="fas fa-plus"></i> Generate Client Certificate
                    </button>
                </div>
                <div class="card-body">
                    [[if client_certs:]]
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Client Name</th>
                                        <th>Serial Number</th>
                                        <th>Valid Until</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    [[for client_name, cert_info in client_certs.items():]]
                                    <tr>
                                        <td><strong>[[=client_name]]</strong></td>
                                        <td><small class="font-monospace">[[=cert_info.get('serial_number', 'N/A')[:16] + '...']]</small></td>
                                        <td>[[=cert_info.get('not_after', 'N/A')[:10] if cert_info.get('not_after') else 'N/A']]</td>
                                        <td>
                                            [[if cert_info.get('revoked'):]]
                                                <span class="badge bg-danger">Revoked</span>
                                            [[else:]]
                                                <span class="badge bg-success">Active</span>
                                            [[pass]]
                                        </td>
                                        <td>
                                            [[if not cert_info.get('revoked'):]]
                                                <div class="btn-group" role="group">
                                                    <a href="[[=URL('certificates/download/client', client_name, 'bundle')]]" 
                                                       class="btn btn-sm btn-success" title="Download Complete Bundle (ZIP)">
                                                        <i class="fas fa-download"></i> Bundle
                                                    </a>
                                                    <a href="[[=URL('certificates/download/client', client_name, 'cert')]]" 
                                                       class="btn btn-sm btn-outline-primary" title="Download Certificate Only">
                                                        <i class="fas fa-certificate"></i>
                                                    </a>
                                                    <a href="[[=URL('certificates/download/client', client_name, 'p12')]]" 
                                                       class="btn btn-sm btn-outline-info" title="Download PKCS#12 Bundle">
                                                        <i class="fas fa-file-archive"></i>
                                                    </a>
                                                    <a href="[[=URL('certificates/client/revoke', client_name)]]" 
                                                       class="btn btn-sm btn-outline-danger" 
                                                       onclick="return confirm('Revoke certificate for [[=client_name]]?')"
                                                       title="Revoke Certificate">
                                                        <i class="fas fa-ban"></i>
                                                    </a>
                                                </div>
                                            [[else:]]
                                                <span class="text-muted">Revoked</span>
                                            [[pass]]
                                        </td>
                                    </tr>
                                    [[pass]]
                                </tbody>
                            </table>
                        </div>
                    [[else:]]
                        <p class="text-muted">No client certificates found. Generate certificates for mTLS authentication.</p>
                    [[pass]]
                </div>
            </div>
        </div>
    </div>
    
    <!-- Usage Instructions -->
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h3>mTLS Configuration Guide</h3>
                </div>
                <div class="card-body">
                    <h5>Server Setup</h5>
                    <p>Enable mTLS on the server:</p>
                    <pre class="bg-light p-3"><code>ENABLE_MTLS=true MTLS_ENFORCE=true python server_optimized.py -m -k server.key -c server.crt</code></pre>
                    
                    <h5 class="mt-3">Client Setup</h5>
                    <p>Configure client with certificates:</p>
                    <pre class="bg-light p-3"><code>python client.py -d example.com -s https://dns.server:8443 \
  --ca-cert ca.crt --client-cert client.crt --client-key client.key</code></pre>
                    
                    <h5 class="mt-3">Environment Variables</h5>
                    <ul>
                        <li><code>ENABLE_MTLS=true</code> - Enable mTLS support</li>
                        <li><code>MTLS_ENFORCE=true</code> - Require client certificates</li>
                        <li><code>MTLS_CA_CERT=certs/ca.crt</code> - CA certificate path</li>
                        <li><code>CERT_DIR=certs</code> - Certificate directory</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Client Certificate Modal -->
<div class="modal fade" id="addClientModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="[[=URL('certificates/client/new')]]">
                <div class="modal-header">
                    <h5 class="modal-title">Generate Client Certificate</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="client_name" class="form-label">Client Name</label>
                        <input type="text" class="form-control" id="client_name" name="client_name" 
                               placeholder="client-001" required>
                        <div class="form-text">Unique identifier for the client</div>
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">Email (Optional)</label>
                        <input type="email" class="form-control" id="email" name="email" 
                               placeholder="client@example.com">
                        <div class="form-text">Will be included in certificate Subject Alternative Name</div>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="client_force" name="force" value="true">
                        <label class="form-check-label" for="client_force">
                            Force regeneration if certificate exists
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Generate Certificate</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.font-monospace {
    font-family: 'Courier New', Courier, monospace;
    font-size: 0.9em;
}
</style>