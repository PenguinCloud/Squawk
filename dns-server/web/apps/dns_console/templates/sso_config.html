[[extend 'layout.html']]

<div class="container">
    <div class="content">
        <h1 class="title">Single Sign-On Configuration</h1>
        
        <div class="notification [[if sso_enabled:]]is-success[[else:]]is-warning[[pass]]">
            <p>
                <strong>SSO Status:</strong> 
                [[if sso_enabled:]]
                    Enabled (Default provider: [[=sso_provider_type.upper()]])
                [[else:]]
                    Disabled
                [[pass]]
            </p>
            [[if not sso_enabled:]]
                <p><small>To enable SSO, set ENABLE_SSO=true in your environment variables and restart the server.</small></p>
            [[pass]]
        </div>
        
        [[if sso_enabled:]]
            <div class="box">
                <h2 class="title is-4">Add New SSO Provider</h2>
                
                <form method="POST" action="[[=URL('admin/sso')]]">
                    <input type="hidden" name="action" value="add_provider">
                    
                    <div class="field">
                        <label class="label">Provider Name</label>
                        <div class="control">
                            <input class="input" type="text" name="name" required
                                   placeholder="e.g., company-saml, internal-ldap">
                        </div>
                        <p class="help">Unique identifier for this provider</p>
                    </div>
                    
                    <div class="field">
                        <label class="label">Provider Type</label>
                        <div class="control">
                            <div class="select">
                                <select name="provider_type" required>
                                    <option value="">Select provider type</option>
                                    <option value="saml">SAML 2.0</option>
                                    <option value="ldap">LDAP/Active Directory</option>
                                    <option value="oauth2">OAuth 2.0</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="field">
                        <label class="label">Configuration (JSON)</label>
                        <div class="control">
                            <textarea class="textarea" name="config" rows="10" required
                                      placeholder='{"sso_url": "https://idp.company.com/sso", "entity_id": "squawk-dns", ...}'></textarea>
                        </div>
                        <p class="help">
                            Provider-specific configuration in JSON format. 
                            <a href="#config-examples">See examples below</a>
                        </p>
                    </div>
                    
                    <div class="field">
                        <div class="control">
                            <button class="button is-primary" type="submit">
                                <span class="icon">
                                    <i class="fas fa-plus"></i>
                                </span>
                                <span>Add Provider</span>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            
            <div class="box">
                <h2 class="title is-4">Configured Providers</h2>
                
                [[if providers:]]
                    <div class="table-container">
                        <table class="table is-fullwidth is-striped">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                [[for provider in providers:]]
                                    <tr>
                                        <td>
                                            <strong>[[=provider.name]]</strong>
                                            <br>
                                            <small>
                                                <a href="[[=URL('auth/sso/login', provider.name)]]" target="_blank">
                                                    Login URL
                                                </a>
                                            </small>
                                        </td>
                                        <td>
                                            <span class="tag [[if provider.provider_type == 'saml':]]is-info[[elif provider.provider_type == 'ldap':]]is-success[[else:]]is-warning[[pass]]">
                                                [[=provider.provider_type.upper()]]
                                            </span>
                                        </td>
                                        <td>
                                            <span class="tag [[if provider.is_enabled:]]is-success[[else:]]is-light[[pass]]">
                                                [[if provider.is_enabled:]]Enabled[[else:]]Disabled[[pass]]
                                            </span>
                                        </td>
                                        <td>[[=provider.created_at.strftime('%Y-%m-%d')]]</td>
                                        <td>
                                            <form method="POST" action="[[=URL('admin/sso')]]" style="display: inline;">
                                                <input type="hidden" name="action" value="toggle_provider">
                                                <input type="hidden" name="provider_id" value="[[=provider.id]]">
                                                <button class="button is-small [[if provider.is_enabled:]]is-warning[[else:]]is-success[[pass]]" 
                                                        type="submit">
                                                    [[if provider.is_enabled:]]Disable[[else:]]Enable[[pass]]
                                                </button>
                                            </form>
                                            
                                            <button class="button is-small is-info" 
                                                    onclick="showConfig([[=provider.id]], '[[=provider.config.replace("'", "\\'")]]')">
                                                View Config
                                            </button>
                                        </td>
                                    </tr>
                                [[pass]]
                            </tbody>
                        </table>
                    </div>
                [[else:]]
                    <div class="notification is-light">
                        <p>No SSO providers configured yet.</p>
                    </div>
                [[pass]]
            </div>
            
            <div class="box" id="config-examples">
                <h2 class="title is-4">Configuration Examples</h2>
                
                <div class="content">
                    <h3>SAML 2.0</h3>
                    <pre><code>{
  "sso_url": "https://idp.company.com/sso/saml",
  "sls_url": "https://idp.company.com/slo/saml",
  "entity_id": "squawk-dns",
  "x509cert": "-----BEGIN CERTIFICATE-----\n...\n-----END CERTIFICATE-----",
  "attribute_mapping": {
    "email": "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress",
    "first_name": "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/givenname",
    "last_name": "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/surname"
  }
}</code></pre>
                    
                    <h3>LDAP/Active Directory</h3>
                    <pre><code>{
  "server": "ldap://dc.company.com:389",
  "base_dn": "dc=company,dc=com",
  "user_dn": "cn=users,dc=company,dc=com",
  "bind_user": "cn=squawk,cn=users,dc=company,dc=com",
  "bind_password": "service-account-password",
  "user_filter": "(sAMAccountName={username})",
  "group_filter": "(member={user_dn})",
  "admin_groups": ["cn=dns-admins,cn=groups,dc=company,dc=com"],
  "attribute_mapping": {
    "email": "mail",
    "first_name": "givenName",
    "last_name": "sn"
  }
}</code></pre>
                    
                    <h3>OAuth 2.0</h3>
                    <pre><code>{
  "client_id": "squawk-dns-client-id",
  "client_secret": "client-secret-here",
  "auth_url": "https://oauth.company.com/oauth/authorize",
  "token_url": "https://oauth.company.com/oauth/token",
  "userinfo_url": "https://oauth.company.com/oauth/userinfo",
  "scopes": ["openid", "profile", "email"],
  "redirect_uri": "https://dns.company.com/dns_console/auth/oauth/callback"
}</code></pre>
                </div>
            </div>
        [[pass]]
        
        <div class="has-text-centered" style="margin-top: 2rem;">
            <a href="[[=URL('index')]]" class="button">
                <span class="icon">
                    <i class="fas fa-arrow-left"></i>
                </span>
                <span>Back to Dashboard</span>
            </a>
        </div>
    </div>
</div>

<!-- Modal for viewing configuration -->
<div class="modal" id="config-modal">
    <div class="modal-background"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">Provider Configuration</p>
            <button class="delete" aria-label="close" onclick="closeConfigModal()"></button>
        </header>
        <section class="modal-card-body">
            <pre id="config-content"></pre>
        </section>
        <footer class="modal-card-foot">
            <button class="button" onclick="closeConfigModal()">Close</button>
        </footer>
    </div>
</div>

<script>
function showConfig(providerId, config) {
    try {
        const formatted = JSON.stringify(JSON.parse(config), null, 2);
        document.getElementById('config-content').textContent = formatted;
        document.getElementById('config-modal').classList.add('is-active');
    } catch (e) {
        document.getElementById('config-content').textContent = config;
        document.getElementById('config-modal').classList.add('is-active');
    }
}

function closeConfigModal() {
    document.getElementById('config-modal').classList.remove('is-active');
}

// Provider type-specific configuration templates
document.addEventListener('DOMContentLoaded', function() {
    const providerTypeSelect = document.querySelector('select[name="provider_type"]');
    const configTextarea = document.querySelector('textarea[name="config"]');
    
    if (providerTypeSelect && configTextarea) {
        providerTypeSelect.addEventListener('change', function() {
            const templates = {
                'saml': `{
  "sso_url": "https://idp.company.com/sso/saml",
  "sls_url": "https://idp.company.com/slo/saml",
  "entity_id": "squawk-dns",
  "x509cert": "-----BEGIN CERTIFICATE-----\\n...\\n-----END CERTIFICATE-----"
}`,
                'ldap': `{
  "server": "ldap://dc.company.com:389",
  "base_dn": "dc=company,dc=com",
  "bind_user": "cn=squawk,cn=users,dc=company,dc=com",
  "bind_password": "service-account-password",
  "user_filter": "(sAMAccountName={username})"
}`,
                'oauth2': `{
  "client_id": "squawk-dns-client-id",
  "client_secret": "client-secret-here",
  "auth_url": "https://oauth.company.com/oauth/authorize",
  "token_url": "https://oauth.company.com/oauth/token",
  "userinfo_url": "https://oauth.company.com/oauth/userinfo"
}`
            };
            
            if (templates[this.value]) {
                configTextarea.value = templates[this.value];
            }
        });
    }
});
</script>