[[extend 'layout.html']]

<div class="container">
    <div class="content">
        <h1 class="title">Multi-Factor Authentication Setup</h1>
        
        [[if step == 'initial':]]
            [[if mfa_enabled:]]
                <div class="notification is-success">
                    <p><strong>MFA is currently enabled</strong> for your account.</p>
                    [[if setup_date:]]
                        <p>Enabled on: [[=setup_date.strftime('%Y-%m-%d at %H:%M')]]</p>
                    [[pass]]
                </div>
                
                <div class="box">
                    <h2 class="title is-4">Disable MFA</h2>
                    <p class="content">
                        To disable MFA, please enter your current password for security verification.
                        <strong>Warning:</strong> Disabling MFA will reduce your account security.
                    </p>
                    
                    <form method="POST" action="[[=URL('mfa/setup')]]">
                        <input type="hidden" name="action" value="disable">
                        
                        <div class="field">
                            <label class="label">Current Password</label>
                            <div class="control">
                                <input class="input" type="password" name="password" required
                                       placeholder="Enter your current password">
                            </div>
                        </div>
                        
                        <div class="field">
                            <div class="control">
                                <button class="button is-danger" type="submit">
                                    Disable MFA
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            [[else:]]
                <div class="notification is-warning">
                    <p><strong>MFA is not enabled</strong> for your account.</p>
                    <p>Enable Multi-Factor Authentication to add an extra layer of security to your account.</p>
                </div>
                
                <div class="box">
                    <h2 class="title is-4">Enable MFA</h2>
                    <p class="content">
                        Multi-Factor Authentication (MFA) adds an extra layer of security to your account by requiring
                        a time-based code from your mobile device in addition to your password.
                    </p>
                    
                    <div class="content">
                        <h3>What you'll need:</h3>
                        <ul>
                            <li>A smartphone or tablet</li>
                            <li>An authenticator app like Google Authenticator, Authy, or Microsoft Authenticator</li>
                        </ul>
                    </div>
                    
                    <form method="POST" action="[[=URL('mfa/setup')]]">
                        <input type="hidden" name="action" value="generate">
                        
                        <div class="field">
                            <div class="control">
                                <button class="button is-primary is-large" type="submit">
                                    <span class="icon">
                                        <i class="fas fa-mobile-alt"></i>
                                    </span>
                                    <span>Set Up MFA</span>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            [[pass]]
        
        [[elif step == 'verify':]]
            <div class="box">
                <h2 class="title is-4">Step 2: Scan QR Code</h2>
                
                <div class="columns">
                    <div class="column is-half">
                        <div class="content">
                            <p><strong>Scan this QR code with your authenticator app:</strong></p>
                            
                            <div class="has-text-centered">
                                <img src="data:image/png;base64,[[=qr_code]]" alt="MFA QR Code"
                                     style="max-width: 256px; height: auto;">
                            </div>
                            
                            <details>
                                <summary><strong>Can't scan the QR code?</strong></summary>
                                <div class="notification is-light">
                                    <p>Manually enter this code in your authenticator app:</p>
                                    <p><code>[[=secret]]</code></p>
                                    <p><strong>Issuer:</strong> [[=issuer]]</p>
                                    <p><strong>Account:</strong> [[=user_email]]</p>
                                </div>
                            </details>
                        </div>
                    </div>
                    
                    <div class="column is-half">
                        <div class="content">
                            <h3>Backup Recovery Codes</h3>
                            <p class="has-text-danger"><strong>Important:</strong> Save these backup codes in a secure location. 
                               You can use them to access your account if you lose your phone.</p>
                            
                            <div class="notification is-warning">
                                <div class="columns is-multiline">
                                    [[for code in backup_codes:]]
                                        <div class="column is-half">
                                            <code>[[=code]]</code>
                                        </div>
                                    [[pass]]
                                </div>
                            </div>
                            
                            <button class="button is-small is-light" onclick="downloadBackupCodes()">
                                <span class="icon is-small">
                                    <i class="fas fa-download"></i>
                                </span>
                                <span>Download Codes</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <hr>
                
                <h3 class="title is-5">Step 3: Verify Setup</h3>
                <p>Enter the 6-digit code from your authenticator app to complete setup:</p>
                
                <form method="POST" action="[[=URL('mfa/setup')]]">
                    <input type="hidden" name="action" value="verify">
                    <input type="hidden" name="secret" value="[[=secret]]">
                    
                    <div class="field has-addons">
                        <div class="control is-expanded">
                            <input class="input is-large has-text-centered" type="text" name="token" 
                                   placeholder="000000" maxlength="6" pattern="[0-9]{6}" required
                                   autocomplete="off" style="font-family: monospace; letter-spacing: 0.2em;"
                                   [[if error:]]autofocus[[pass]]>
                        </div>
                        <div class="control">
                            <button class="button is-primary is-large" type="submit">
                                <span class="icon">
                                    <i class="fas fa-check"></i>
                                </span>
                                <span>Verify & Enable</span>
                            </button>
                        </div>
                    </div>
                    
                    [[if error:]]
                        <p class="help is-danger">
                            <i class="fas fa-exclamation-triangle"></i>
                            Invalid verification code. Make sure your device clock is synchronized and try again.
                        </p>
                    [[pass]]
                </form>
                
                <div class="notification is-light">
                    <p><strong>Note:</strong> The code changes every 30 seconds. If the code doesn't work, 
                       wait for the next one and try again.</p>
                </div>
            </div>
        [[pass]]
        
        <div class="has-text-centered" style="margin-top: 2rem;">
            <a href="[[=URL('index')]]" class="button">
                <span class="icon">
                    <i class="fas fa-arrow-left"></i>
                </span>
                <span>Back to Dashboard</span>
            </a>
        </div>
    </div>
</div>

<script>
function downloadBackupCodes() {
    const codes = [
        [[for code in backup_codes:]]
            '[[=code]]',
        [[pass]]
    ];
    
    const content = 'Squawk DNS MFA Backup Codes\n' +
                   'Generated: ' + new Date().toISOString() + '\n' +
                   'Account: [[=user_email]]\n\n' +
                   'Backup Codes (use each code only once):\n\n' +
                   codes.join('\n') +
                   '\n\nKeep these codes secure and do not share them with anyone.';
    
    const blob = new Blob([content], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'squawk-dns-backup-codes.txt';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

// Auto-submit form when 6 digits are entered
document.addEventListener('DOMContentLoaded', function() {
    const tokenInput = document.querySelector('input[name="token"]');
    if (tokenInput) {
        tokenInput.addEventListener('input', function() {
            if (this.value.length === 6 && /^\d{6}$/.test(this.value)) {
                // Small delay to allow user to see the complete code
                setTimeout(() => {
                    this.closest('form').submit();
                }, 500);
            }
        });
    }
});
</script>